<!DOCTYPE HTML PUBLIC>
<html>
<head>
    <title>Species MVC</title>

    <script src="../js/species.js"></script>
    <script src="../js/plugins/species.aop.js"></script>
    <script src="../js/plugins/species.watch.js"></script>
    <script src="species.dom.js"></script>
    <script src="species.model.js"></script>
    <script src="species.controller.js"></script>
</head>
<body>

    <div id="customersView">
        <button id="cmd01">Le 1er client avec un budget de 3000</button>
        <button id="cmd02">Les clients avec un budget de 3000</button>
        <customers_list></customers_list>

        <result></result>
    </div>


</body>

<script>

</script>
<script id="Species_MVC">

    console.log('<b>/*--- Species MVC ---*/</b>');

    var Supplier = Species.Class({
        Extends : Species.Model,
        /*--- default values ---*/
        Name : "John Doe",
        Code : "???",

        initialize : function _Supplier(args) {
            args.Name ? this.Name = args.Name : null;
            args.Code ? this.Code = args.Code : null;
        }
    });

    var Bob = Supplier.New({ Name : 'Bob Morane', Code : '12345' });

    Bob.watch('Name', function(result){ console.log('Name has changed',result); });
    Bob.watch('Code', function(result){ console.log('Code has changed',result); });



    (function () {

        var Customer = Species.Class({
            Extends : Species.Model,

            Name : {
                get : function() { return this.Name; },
                set : function(value) { this.Name = value; }
            },

            Budget : {
                get : function() { return this.budget; },
                set : function(value) { this.budget = value; }
            },

            initialize : function _Customer(id, name, budget){
                console.log(this.UID);
                this.Name = name;
                this.id = id;
                this.budget  = budget;
            }
        });

        var Customers = Species.Class({
            Extends : Species.ModelHelper,

            initialize : function _CustomerHelper() {
                this.Model = Customer;
            }
        });


        var CustomerController = Species.Class({
            Extends : Species.Controller,

            populate : function() {
                var toto = Customer.New("001", "TOTO", 45000);
                var tutu = Customer.New("002", "TUTU", 3000);
                var tata = this.customers.clone(tutu);
                tata.Id = "003";
                tata.Name = "TATA";

                //this.customers.add([toto, tutu, tata]);
                this.customers.add(toto);
                this.customers.add(tutu);
                this.customers.add(tata);

                this.customers.save(toto);
                this.customers.save(tutu);
                this.customers.save(tata);


                $dom('customers_list').add('ul',{attr:{id:'the_list'}});

                this.customers.getAll().forEach(function(e) {
                    $dom('#the_list').add('li',{ prop : { innerHTML : e.Id + " : " + e.Name + " : " + e.Budget } });
                });


                /*
                $dom('customers_list').add('ul');

                this.customers.getAll().forEach(function(e) {
                    $dom('ul').add('li',{ prop : { innerHTML : e.Id + " : " + e.Name + " : " + e.Budget } });
                });
                */
                

            },

            initialize : function _CustomerController() {
                var that = this;

                this.customers = Customers.New(),

                this.customers.bind({
                    method : "add",
                    before : function(data){ console.log("BEFORE ADD : " + data.Name); } ,
                    after : function(data){ console.log("AFTER ADD : " + data.Name); }
                });

                this.customers.bind({
                    method : "save",
                    after : function(data){ console.log(data.UID + " : " + data.Name + " ("+ data.Id +") SAVED"); }
                })

                //this.View = $dom('#customersView').find(); /* pour le moment pas utilis√©e */
                
                this.Events = [
                    {
                        what : '#cmd01',
                        event : 'click',
                        onEvent : function(){
                            //$dom.find('result').innerHTML = that.customers.getAll().filter(function(e) { return e.Budget === 3000; } )[0].Name;

                            $dom('result').set({
                                prop : {
                                    innerHTML : that.customers.getAll().filter(function(e) { return e.Budget === 3000; } )[0].Name
                                }
                            });
                        }
                    },
                    {
                        what : '#cmd02',
                        event : 'click',
                        onEvent : function(){
                            //$dom.find('result').innerHTML = '';
                            $dom('result').set({ prop : { innerHTML : ''} });

                            that.customers.getAll().filter(function(e) {
                                return e.Budget === 3000;
                            } ).forEach(function(e){
                                        //$dom.find('result').innerHTML += e.Name + ' - ' ;
                                        $dom('result').set({
                                            prop : {
                                                innerHTML : $dom('result').get({ prop:'innerHTML' }) + e.Name + ' - '
                                            }
                                        });
                                    });
                        }
                    }
                ];

                this.populate();
            }
        });

        var control = CustomerController.New();
    }());



</script>

</html>